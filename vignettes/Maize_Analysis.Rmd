---
  title: "Diffusion of Maize Agriculture to the Southwestern United States"
author: "Andrew Gillreath-Brown"
date: "`r format(Sys.time(), '%d %B %Y')`"
html_document:
  toc: yes
toc_depth: 2
toc_float: yes
number_sections: no
code_folding: hide
output:
  html_document:
  df_print: paged
mainfont: Calibri
editor_options:
  chunk_output_type: console
keep_md: yes
---
  
```{r setup, include = FALSE, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE)

# devtools::install()
# devtools::load_all()
library(cropDiffusionR)
require(ggh4x)

```

# Load the final reconstruction data.

```{r load_data, message = FALSE, warning = FALSE, results = 'hide'}

# Load the temperature anomaly reconstruction from paleoMAT.
temp_anom <-
  readr::read_csv(
    "https://raw.githubusercontent.com/Archaeo-Programmer/paleoMAT/master/vignettes/tables/supp_table_s2.csv",
    show_col_types = FALSE
  ) %>%
  dplyr::rename(
    year = 1,
    anom = 2,
    ci = 3,
    se = 4
  )

write.csv(cropDiffusionR::maizeDB,
          here::here("vignettes/tables/tableS1.csv"),
          row.names = FALSE)

# Load location data for each sample. We do not present site locations in order to protect site locations.
MDB <- cropDiffusionR::maizeDB %>%
  dplyr::left_join(
    .,
    readr::read_csv(
      "../Paper 2/Maize_Database_Locations_DONT_DISTRIBUTE.csv",
      col_types = readr::cols()
    ),
    by = "LabID"
  )

# Get the annual accumulated growing degree days for each sample.
MDB_gdd <- MDB %>%
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  dplyr::select(LabID) %>%
  cropDiffusionR::extract_GDD() %>%
  dplyr::select(-geometry)

```

```{r Figure_1, fig.cap="Low-frequency July temperature anomaly reconstruction for the southwestern United States as defined in inset (based on (Gillreath-Brown, Bocinsky, and Kohler, n.d., fig. 5)). Blue line fitted by loess smoothing (α = 0.15). Negative values on y-axis indicate cooler-than-modern low-frequency conditions; horizontal line at 0 marks modern average July temperatures. Negative values on x-axis indicate years BC.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

# Create a bounding box for limits of this study
bb <-
  c(
    "xmin" = -112.81446,
    "xmax" = -105.52416,
    "ymin" = 32.65757,
    "ymax" = 38.089
  ) %>%
  sf::st_bbox() %>%
  sf::st_as_sfc() %>%
  sf::st_as_sf(crs = 4326) %>%
  sf::st_transform(crs = 4326)

usa <-
  sf::st_as_sf(maps::map("state", fill = TRUE, plot = FALSE)) %>%
  sf::st_transform(., crs = 4326) %>%
  dplyr::filter(ID %in% c("colorado", "utah", "arizona", "new mexico"))

paleomat_extent <-
  ggplot2::ggplot() +
  theme_bw() +
  scale_x_continuous(breaks = seq(-115, -103, 2.0),
                     limits = c(-115, -103.2)) +
  scale_y_continuous(breaks = seq(31, 39, 2.0),
                     limits = c(31.25, 39)) +
  geom_sf(
    data = usa,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.25
  ) +
  geom_sf(
    data = bb,
    size = 0.75,
    fill = NA,
    aes(colour = "slategrey",
        linetype = "dashed"),
    show.legend = "line",
    inherit.aes = FALSE
  ) +
  scale_color_manual(
    values = c("slategrey" = "slategrey"),
    labels = c("Gillreath-Brown et al. n.d. \n Study Area"),
    name = "Data Extent"
  ) +
  scale_linetype_manual(
    values = c("dashed" = "dashed"),
    labels = c("Gillreath-Brown et al. n.d. \n Study Area"),
    name = "Data Extent"
  ) +
  labs(colour = "") +
  annotate(
    "text",
    x = -109.2,
    y = 37.5,
    label = "UTAH",
    size = 4,
    fontface = 2,
    hjust = 1.0
  ) +
  annotate(
    "text",
    x = -108.90,
    y = 37.5,
    label = "COLORADO",
    size = 4,
    fontface = 2,
    hjust = 0
  ) +
  annotate(
    "text",
    x = -109.2,
    y = 36.3,
    label = "ARIZONA",
    size = 4,
    fontface = 2,
    hjust = 1
  ) +
  annotate(
    "text",
    x = -108.90,
    y = 36.3,
    label = "NEW MEXICO",
    size = 4,
    fontface = 2,
    hjust = 0
  ) +
  theme(
    legend.position = "right",
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.text.x = element_blank(),
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = "transparent",
                                    colour = NA_character_),
    plot.background = element_rect(fill = "transparent",
                                   colour = NA_character_),
    # necessary to avoid drawing plot outline
    legend.background = element_rect(fill = "transparent", color = NA),
    legend.box.background = element_rect(fill = "transparent", color = NA),
    legend.key = element_rect(fill = "transparent", color = NA),
    legend.box.margin = margin(-10,-10,-10,-20)
  )


anom_plot <- temp_anom %>%
  ggplot2::ggplot(aes(x = year, y = anom)) +
  geom_ribbon(aes(ymax = anom + se, ymin = anom - se), alpha = 0.2) +
  geom_line(size = 2, colour = "cornflowerblue") +
  geom_hline(
    yintercept = 0,
    linetype = 'dashed',
    color = c('darkslategray')
  ) +
  scale_x_continuous(
    limits = c(-3000, 2100),
    breaks = seq(-3000, 2000, 500),
    minor_breaks = seq(-2900, 2000, by = 100),
    guide = "axis_minor",
    labels = c(seq(-3000, -500, 500), 1, seq(500, 2000, 500))
  ) +
  scale_y_continuous(
    limits = c(-2.5, 2.5),
    breaks = seq(-2.5, 2.5, 0.5),
    minor_breaks = seq(-2.5, 2.5, by = 0.25),
    guide = "axis_minor"
  ) +
  theme_bw() +
  xlab("Years BC/AD") +
  ylab("Temperature Anomaly (°C)") +
  theme(
    axis.ticks.length = unit(0.125, "inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )


plot.with.inset <-
  cowplot::ggdraw() +
  cowplot::draw_plot(anom_plot) +
  cowplot::draw_plot(
    paleomat_extent,
    x = 0.04,
    y = .638,
    width = .51,
    height = .34
  )

ggplot2::ggsave(
  filename = "vignettes/figures/Figure_1.png",
  plot = plot.with.inset,
  width = 15.51,
  height = 10.32,
  dpi = 600
)


```

```{r Figure_2, fig.cap="Low-frequency July temperature anomaly for the SWUS (Gillreath-Brown, Bocinsky, and Kohler, n.d.) and the Northern Hemisphere low-frequency component (Moberg et al. 2005) from AD 133 to 1900. Both series have been standardized to a mean of 0 and an s of 1 for the period in the graph.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

temp_anom_standard <-
  readr::read_csv(
    "https://raw.githubusercontent.com/Archaeo-Programmer/paleoMAT/master/vignettes/tables/supp_table_s2.csv",
    show_col_types = FALSE
  ) %>%
  dplyr::mutate(Year = as.integer(Year)) %>%
  dplyr::filter(Year >= 133 & Year <= 1900) %>%
  dplyr::mutate(Series = "Gillreath-Brown et al. n.d.") %>%
  dplyr::select(year = Year, anom = 2, Series)

Moberg_standard <- paleomat::moberg_2005 %>%
  dplyr::mutate(Series = "Moberg et al. 2005") %>%
  dplyr::select(year = date, anom = LF, Series) %>%
  dplyr::filter(year >= 133 & year <= 1900)

Moberg_paleomat <-
  dplyr::bind_rows(temp_anom_standard, Moberg_standard)

# Moberg LF and paleomat
Moberg_paleomat_fig <- Moberg_paleomat %>%
  dplyr::group_by(Series) %>%
  dplyr::mutate(update = (anom - mean(anom)) / sd(anom)) %>%
  ggplot2::ggplot(aes(x = year, y = update, colour = Series)) +
  geom_hline(
    yintercept = 0,
    color = "darkgrey",
    lty = 2,
    lwd = 1.25
  ) +
  geom_line(size = 2.0) +
  scale_color_manual(values = c("#A60F2D", "cornflowerblue")) +
  xlab("Years AD") +
  ylab("Standardized Temperature Values (Z-Scores)") +
  scale_x_continuous(
    limits = c(0, 2000),
    breaks = seq(0, 2000, 200),
    minor_breaks = seq(0, 2000, by = 100),
    guide = "axis_minor",
    labels = c(1, seq(200, 2000, 200))
  ) +
  scale_y_continuous(breaks = seq(-2, 3, 0.5)) +
  theme_bw() +
  guides(color = guide_legend(override.aes = list(fill = NA), direction = "horizontal")) +
  theme(
    legend.text = element_text(size = 19, family = "Helvetica"),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.margin = margin(t = -14),
    axis.ticks.length = unit(0.125, "inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  Moberg_paleomat_fig,
  filename = "vignettes/figures/Figure_2.png",
  width = 17.25,
  height = 11.5,
  dpi = 600
)

```

```{r Figure_4, fig.cap="Earliest site with maize in each of the labeled political subdivisions, using data from the Ancient Maize Map (Blake et al. 2017) with additions listed in Table S1. The linear model shows the regression of date on latitude for the labeled sites. The slope of the regression line implies an average spread rate of 0.001 degrees/year for this sample (r2 = 0.01; p > F = 0.72).", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

# Subset the dataframe to only have the 2 sigma data and the unique lab code.
MDB_min_fig4 <- MDB %>%
  dplyr::group_by(Province) %>%
  dplyr::slice_max(MedianBP) %>%
  dplyr::select(LabID, SiteName, Date, Lat, everything()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(Lat >= Lat[SiteName == "Guila Naquitz"])

# Linear Model and Stats
lm1 <- lm(Lat ~ Date, data = MDB_min_fig4)
setNames(c(
  formatC(lm1$coefficients[["Date"]], digits = 3, format = "f"),
  formatC(summary(lm1)$r.squared, digits = 2, format = "f"),
  formatC(
    summary(lm1)$coefficients[2, 4],
    digits = 3,
    format = "f"
  ),
  formatC(
    summary(lm1)$fstatistic[[1]],
    digits = 2,
    format = "f"
  )
),
c("slope", "r2", "pvalue", "Fstat"))

# Plot using a linear model.
figure4 <-
  MDB_min_fig4 %>%
  dplyr::mutate(Province = as.factor(Province)) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(labels = paste0(
    stringr::str_replace(SiteName, " \\s*\\([^\\)]+\\)", ""),
    ", \n ",
    Province
  )) %>%
  ggplot(aes(x = Date, y = Lat)) +
  geom_point(size = 4, aes(shape = forcats::fct_rev(Country))) +
  scale_shape_manual(values = c(19, 15), name = "Country") +
  geom_smooth(
    aes(group = 1),
    method = 'lm',
    se = FALSE,
    linetype = 1,
    color = "black"
  ) +
  ggrepel::geom_label_repel(
    aes(label = labels),
    max.iter = 4500,
    cex = 6.7,
    show.legend  = F,
    min.segment.length = unit(0, 'lines'),
    force = 25,
    box.padding = 1
  ) +
  scale_x_continuous(
    breaks = seq(-4500, 1500, 500),
    minor_breaks = seq(-4500, 1500, 100),
    limits = c(-4500, 1500),
    guide = "axis_minor",
    labels = c(seq(-4500,-500, 500), 1, seq(500, 1500, 500))
  ) +
  scale_y_continuous(
    breaks = seq(10, 45, 5),
    minor_breaks = seq(10, 45, 1),
    limits = c(10, 45),
    guide = "axis_minor"
  ) +
  xlab("Years BC/AD") +
  ylab("Latitude") +
  # ggpubr::color_palette(palette = "jco") +
  theme_bw()  +
  guides(color = guide_legend(override.aes = list(fill = NA), direction = "horizontal")) +
  theme(
    legend.title = element_text(
      size = 19,
      family = "Helvetica",
      face = "bold"
    ),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.text = element_text(size = 18, colour = "black"),
    legend.margin = margin(t = -14),
    axis.ticks.length = unit(0.125, "inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 7,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 7,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  figure4,
  filename = "vignettes/figures/Figure_4.png",
  width = 17.25,
  height = 11.5,
  dpi = 600
)

```

```{r Figure_5, fig.cap="Location of maize’s northern frontier through time. Shown is the earliest site with maize in each century, with the constraint that only sites further north than earlier sites appear in the plot. Data from the Ancient Maize Map (Blake et al. 2017) with additions listed in Table S1. The linear model shows the regression of date on latitude for the labeled sites. The slope of the regression line implies an average spread rate of 0.003 degrees/year for this sample (r2 = 0.76; p > F < 0.001). Between just Guilà Naquitz and Las Capas however the implied rate of spread is ~8.7 times more rapid (0.026 degrees/year).", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

# Subset the dataframe to only have the 2 sigma data and the unique lab code.
MDB_min_fig5 <- MDB %>%
  # Create 100 year bins.
  dplyr::mutate(bin = cut(
    MedianBP,
    breaks = seq(
      plyr::round_any(min(MedianBP), 100, f = floor),
      plyr::round_any(max(MedianBP), 100, f = ceiling),
      by = 100
    ),
    include.lowest = TRUE
  )) %>%
  dplyr::group_by(bin) %>%
  dplyr::slice_max(Lat) %>%
  dplyr::slice_max(MedianBP) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(desc(MedianBP)) %>%
  dplyr::filter(Lat == cummax(Lat)) %>%
  dplyr::select(LabID, SiteName, Date, bin, everything()) %>%
  dplyr::filter(Date <= 1500) %>%
  dplyr::group_by(SiteName) %>%
  dplyr::slice_min(Date, with_ties = FALSE) %>%
  dplyr::ungroup()

# Linear Model and Stats
lm1 <- lm(Lat ~ Date, data = MDB_min_fig5)
setNames(c(
  formatC(lm1$coefficients[["Date"]], digits = 3, format = "f"),
  formatC(summary(lm1)$r.squared, digits = 2, format = "f"),
  formatC(
    summary(lm1)$coefficients[2, 4],
    digits = 3,
    format = "f"
  ),
  formatC(
    summary(lm1)$fstatistic[[1]],
    digits = 2,
    format = "f"
  )
),
c("slope", "r2", "pvalue", "Fstat"))

# Plot using a linear model.
figure5 <-
  MDB_min_fig5 %>%
  dplyr::mutate(Province = forcats::fct_reorder(Province, Date, .fun = 'min')) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(SiteName = ifelse(SiteName == "Elsinore Burial", SiteID, SiteName)) %>%
  dplyr::mutate(labels = stringr::str_replace(SiteName, " \\s*\\([^\\)]+\\)", "")) %>%
  ggplot(aes(x = Date, y = Lat)) +
  geom_point(size = 4, aes(color = Province, shape = Province)) +
  geom_smooth(
    aes(group = 1),
    method = 'lm',
    se = FALSE,
    linetype = 1,
    color = "black"
  ) +
  # stat_poly_eq(aes(label = paste(after_stat(eq.label),
  #                              after_stat(rr.label), sep = "*\", \"*"))) +
  ggrepel::geom_label_repel(
    aes(colour = Province, label = labels),
    max.iter = 4500,
    cex = 6.7,
    show.legend  = F,
    min.segment.length = unit(0, 'lines'),
    force = 25,
    box.padding = 1,
    max.overlaps = 16
  ) +
  scale_x_continuous(
    breaks = seq(-4500, 1500, 500),
    minor_breaks = seq(-4500, 1500, 100),
    limits = c(-4500, 1500),
    guide = "axis_minor",
    labels = c(seq(-4500, -500, 500), 1, seq(500, 1500, 500))
  ) +
  scale_y_continuous(
    breaks = seq(15, 45, 5),
    minor_breaks = seq(15, 45, 1),
    limits = c(15, 45),
    guide = "axis_minor"
  ) +
  xlab("Years BC/AD") +
  ylab("Latitude") +
  scale_shape_manual(
    values = c(3, 19, 15, 17, 9),
    name = "States",
    labels = c("Oxaca", "Arizona", "New Mexico", "Utah", "Colorado")
  ) +
  scale_color_manual(
    values = ggsci::pal_jco("default")(10)[c(1, 3, 2, 4, 6)],
    name = "States",
    labels = c("Oxaca", "Arizona", "New Mexico", "Utah", "Colorado")
  ) +
  theme_bw()  +
  theme(
    legend.position = "bottom",
    legend.title = element_text(
      size = 19,
      family = "Helvetica",
      face = "bold"
    ),
    legend.direction = "horizontal",
    legend.text = element_text(size = 18, colour = "black"),
    legend.margin = margin(t = -14),
    axis.ticks.length = unit(0.125, "inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 7,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 7,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  figure5,
  filename = "vignettes/figures/Figure_5.png",
  width = 17.25,
  height = 11.5,
  dpi = 600
)

```

```{r Figure_6, fig.cap="Location of maize’s northern frontier through time within or near the SWUS as defined here. The slope of the regression line implies an average spread rate of 0.002 degrees/year for this sample (r2 = 0.95; p > F < 0.001).", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

# subset the dataframe to only have the 2 sigma data and the unique lab code.
MDB_min_fig6 <- MDB %>%
  dplyr::filter(Country == "USA") %>%
  # Create 100 year bins.
  dplyr::mutate(bin = cut(
    MedianBP,
    breaks = seq(
      plyr::round_any(min(MedianBP), 100, f = floor),
      plyr::round_any(max(MedianBP), 100, f = ceiling),
      by = 100
    ),
    include.lowest = TRUE
  )) %>%
  dplyr::group_by(bin) %>%
  dplyr::slice_max(Lat) %>%
  dplyr::slice_max(MedianBP) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(desc(MedianBP)) %>%
  dplyr::filter(Lat == cummax(Lat)) %>%
  dplyr::select(LabID, SiteName, Date, bin, everything()) %>%
  dplyr::filter(Date <= 1500) %>%
  dplyr::group_by(SiteName) %>%
  dplyr::slice_min(Date, with_ties = FALSE) %>%
  dplyr::ungroup()

# Linear Model and Stats
lm1 <- lm(Lat ~ Date, data = MDB_min_fig6)
setNames(c(
  formatC(lm1$coefficients[["Date"]], digits = 3, format = "f"),
  formatC(summary(lm1)$r.squared, digits = 2, format = "f"),
  formatC(
    summary(lm1)$coefficients[2, 4],
    digits = 3,
    format = "f"
  ),
  formatC(
    summary(lm1)$fstatistic[[1]],
    digits = 2,
    format = "f"
  )
),
c("slope", "r2", "pvalue", "Fstat"))

# Plot using a linear model.
figure6 <-
  MDB_min_fig6 %>%
  dplyr::mutate(Province = forcats::fct_reorder(Province, Date, .fun = 'min')) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(SiteName = ifelse(SiteName == "Elsinore Burial", SiteID, SiteName)) %>%
  dplyr::mutate(labels = stringr::str_replace(SiteName, " \\s*\\([^\\)]+\\)+$", "")) %>%
  ggplot(aes(x = Date, y = Lat)) +
  geom_point(size = 4, aes(color = Province, shape = Province)) +
  geom_smooth(
    aes(group = 1),
    method = 'lm',
    se = FALSE,
    linetype = 1,
    color = "black"
  ) +
  # stat_poly_eq(aes(label = paste(after_stat(eq.label),
  #                              after_stat(rr.label), sep = "*\", \"*"))) +
  ggrepel::geom_label_repel(
    aes(colour = Province, label = labels),
    max.iter = 4500,
    cex = 6.7,
    show.legend  = F,
    min.segment.length = unit(0, 'lines'),
    force = 25,
    box.padding = 1,
    max.overlaps = 15
  ) +
  scale_shape_manual(
    values = c(19, 15, 17, 9),
    name = "States",
    labels = c("Arizona", "New Mexico", "Utah", "Colorado")
  ) +
  scale_color_manual(
    values = ggsci::pal_jco("default")(10)[c(3, 2, 4, 6)],
    name = "States",
    labels = c("Arizona", "New Mexico", "Utah", "Colorado")
  ) +
  scale_x_continuous(
    breaks = seq(-4500, 1500, 500),
    minor_breaks = seq(-4500, 1500, 100),
    limits = c(-4500, 1500),
    guide = "axis_minor",
    labels = c(seq(-4500, -500, 500), 1, seq(500, 1500, 500))
  ) +
  scale_y_continuous(
    breaks = seq(30, 42, 2),
    minor_breaks = seq(30, 42, 1),
    limits = c(30, 42),
    guide = "axis_minor"
  ) +
  xlab("Years BC/AD") +
  ylab("Latitude") +
  theme_bw()  +
  theme(
    legend.position = "bottom",
    legend.title = element_text(
      size = 19,
      family = "Helvetica",
      face = "bold"
    ),
    legend.direction = "horizontal",
    legend.text = element_text(size = 18, colour = "black"),
    legend.margin = margin(t = -14),
    axis.ticks.length = unit(0.125, "inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 7,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 7,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  figure6,
  filename = "vignettes/figures/Figure_6.png",
  width = 17.25,
  height = 11.5,
  dpi = 600
)

```

```{r Figure_3, fig.cap="Annual accumulated growing degree days across the southwestern United States and Mexico, with locations of sites mentioned in the text or the following figures. Growing degree days were extracted and calculated from the 30 seconds (~1 km2) average temperature (°C) from WorldClim version 2.1 (https://www.worldclim.org/data/worldclim21.html). We use 10°C as the base and 30°C as the maximum for the GDD calculation.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

# Placing Figure 3 after Figures 4-6 since we use the sites from those figures to plot on to the GDD map.
NASW_sites <-
  dplyr::bind_rows(MDB_min_fig4, MDB_min_fig5, MDB_min_fig6) %>%
  dplyr::ungroup() %>%
  dplyr::select(SiteName, SiteID, Long, Lat) %>%
  dplyr::mutate(SiteName = dplyr::coalesce(SiteName, SiteID)) %>%
  dplyr::distinct(SiteName, .keep_all = TRUE) %>%
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326)

# Get raster for the North American Southwest and convert to a dataframe.
NASW_gdd_data <-
  raster::as.data.frame(cropDiffusionR::NASW_gdd, xy = TRUE)
# Assign names to the columns.
names(NASW_gdd_data) <- c("long", "lat", "GDD")
#Transform the data for plotting in ggplot.
NASW_gdd_data_transformed <-
  usmap::usmap_transform(
    NASW_gdd_data,
    input_names = c("long", "lat"),
    output_names = c("x", "y")
  )

# Get data to do the alpha hack for additional relief in the GDD map plot.
# # Put elevation and temperature rasters in the same resolution.
# ned_SW <- raster::projectRaster(cropDiffusionR::NASW_elevation, cropDiffusionR::NASW_gdd, method = 'ngb')
#
# ned_SW_crop <- raster::crop(ned_SW, usa_mexico_states)
# #then mask out (i.e. assign NA) the values outside the polygon
# ned_SW_mask <- raster::mask(ned_SW_crop, usa_mexico_states)
#
# # Create a hillshade file.
# slope <- raster::terrain(ned_SW_mask, opt='slope')
# aspect <- raster::terrain(ned_SW_mask, opt='aspect')
# hill <- raster::hillShade(slope, aspect,
#                           angle = 40,
#                           direction = 270)
# hill_spdf <- as(hill, "SpatialPixelsDataFrame")
# hill_spdf <- raster::as.data.frame(hill_spdf)
# colnames(hill_spdf) <- c("value", "x", "y")
#

figure3 <-
  ggplot2::ggplot(data = NASW_gdd_data_transformed) +
  # ggplot2::geom_raster(
  #   data = hill_spdf,
  #   mapping = aes(x = x,
  #                 y = y,
  #                 alpha = value),
  #   na.rm = TRUE,
  #   inherit.aes = FALSE
  # ) +
  # # use the "alpha hack"
  # scale_alpha(
  #   name = "",
#   range = c(0.6, 0),
#   na.value = 0,
#   #limits = c(0,255),
#   guide = FALSE
# )  +
geom_raster(aes(x = long, y = lat, fill = GDD),
            alpha = 0.8,
            na.rm = TRUE) +
  # For doing the raster in greyscale.
  scale_fill_gradientn(
    colors = grey.colors(
      10,
      start = 0.15,
      end = 0.9,
      rev = TRUE
    ),
    na.value = "transparent",
    name = "Annual GDDs"
  ) +
  # For doing the raster in color.
  # scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
  #                      na.value = "transparent",
  #                      name = "Annual GDDs") +
  coord_equal() +
  theme_bw() +
  geom_sf(
    data = cropDiffusionR::usa_mexico_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  geom_sf(data = NASW_sites,
          aes(geometry = geometry),
          inherit.aes = FALSE) +
  ggrepel::geom_label_repel(
    data = NASW_sites,
    aes(label = SiteName, geometry = geometry),
    stat = "sf_coordinates",
    min.segment.length = 0.4,
    force = 47,
    label.size = 0,
    size = 4.5,
    inherit.aes = FALSE,
    max.overlaps = 20
  ) +
  theme(
    legend.position = c(.15, .2),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.text.x = element_blank(),
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.text = element_text(size = 15, family = "Helvetica"),
    legend.title = element_text(
      size = 16,
      family = "Helvetica",
      face = "bold"
    )
  )

ggplot2::ggsave(
  figure3,
  filename = "vignettes/figures/Figure_3.png",
  width = 15.43,
  height = 13.15,
  dpi = 600
)

```

# Supplemental Figures

```{r maize_frontier_animation, fig.cap="Each maize site with a maize sample is plotted on modern accumulated growing degree days. Sites were binned into 100 year intervals for plotting. Many centuries have no recorded samples; thus, they are not plotted here. Growing degree days were extracted and calculated from the 30 seconds (~1 km2) average temperature (°C) from WorldClim version 2.1 (https://www.worldclim.org/data/worldclim21.html). We use 10°C as the base and 30°C as the maximum for the GDD calculation.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

# Animation to show location of maize sites in 100 year bins.
NASW_sites2 <- MDB %>% 
  dplyr::select(LabID, SiteName, SiteID, Long, Lat, Date) %>% 
  dplyr::mutate(SiteName = dplyr::coalesce(SiteName, SiteID)) %>% 
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>% 
  dplyr::group_by(period = cut(Date, breaks = seq(-4300, 1900, 100),
                               labels = seq(-4300, 1800, 100))) %>% 
  dplyr::mutate(period = as.numeric(as.character(period)),
                label = ifelse(SiteName %in% NASW_sites$SiteName, SiteName, NA_character_)) %>% 
  dplyr::arrange(period) %>% 
  dplyr::distinct(geometry, .keep_all = TRUE) %>% 
  split(.$period)

NASW_sites2_names <-
  data.frame(century = as.numeric(names(NASW_sites2))) %>%
  dplyr::mutate(
    century = ifelse(century == 0, 1, century),
    century = ifelse(
      century < 0,
      paste(century, "to", century + 100, "BC"),
      paste("AD", century, "to", century + 100)
    ),
    century = str_replace_all(century, "[-]", "")
  ) %>%
  dplyr::pull(century)

maize_through_time_gdd <- purrr::map2(NASW_sites2, NASW_sites2_names, function(x, y)
  ggplot2::ggplot(data = NASW_gdd_data_transformed) +
    geom_raster(aes(x = long, y = lat, fill = GDD),
      alpha = 0.8,
      na.rm = TRUE
    ) +
    scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
                         na.value = "transparent",
                         name = "Annual GDDs") +
    coord_equal() +
    theme_bw() +
    geom_sf(
      data = cropDiffusionR::usa_mexico_states,
      color = "#2b2b2b",
      fill = "transparent",
      size = 0.4,
      inherit.aes = FALSE
    ) +
    geom_sf(
      data = x,
      aes(geometry = geometry),
      size = 4,
      inherit.aes = FALSE
    ) +
    ggrepel::geom_label_repel(
      data = x,
      aes(label = label, geometry = geometry),
      stat = "sf_coordinates",
      min.segment.length = 0.4,
      force = 47,
      label.size = 0,
      size = 4.5,
      inherit.aes = FALSE,
      max.overlaps = 20
    ) +
    ggtitle(y) +
    theme(
      #legend.key.width = unit(1.25, 'cm'),
      plot.title = element_text(hjust = 0.5, size = 20, family = "Helvetica", face = "bold"),
      legend.position = c(.15, .2),
      panel.border = element_blank(),
      panel.grid.major = element_blank(),
      axis.text = element_blank(),
      axis.text.x = element_blank(),
      axis.title = element_blank(),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      legend.text = element_text(size = 15, family = "Helvetica"),
      legend.title = element_text(
        size = 16,
        family = "Helvetica",
        face = "bold"
      )
    ))

invisible(mapply(ggsave, file=paste0("/Users/andrew/Dropbox/WSU/SKOPEII/model/Paper 2/Figures/animation", names(maize_through_time_gdd), ".png"), width = 15.43, height = 13.15, dpi = 300, plot=maize_through_time_gdd))


#Gif animation
## list file names and read in
imgs <- list.files("/Users/andrew/Dropbox/WSU/SKOPEII/model/Paper 2/animation/", full.names = TRUE)
# index = c(15, 14, 13, 12, 11, 9, 8, 7, 6, 10, 5, 1, 2, 3, 4)
# index = c(4, 3, 2, 1, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)
# imgs = imgs[order(index)]
img_list <- lapply(imgs, magick::image_read)

## join the images together
img_joined <- image_join(maize_through_time_gdd)

## animate at 2 frames per second
img_animated <- image_animate(img_joined, fps = 2)

## view animated image
img_animated

## save to disk
image_write(image = img_animated,
            path = "/Users/andrewgillreath-brown/Dropbox/WSU/SKOPEII/Figures/animation/maize_anomaly_plots_arranged.gif")

```

```{r maize_rayshader, fig.cap="Every sample in our maize database is plotted on this graph by date and latitude. Additionally, we include the modern annual accumulated growing degree days for the site location of the sample. Growing degree days were extracted and calculated from the 30 seconds (~1 km2) average temperature (°C) from WorldClim version 2.1 (https://www.worldclim.org/data/worldclim21.html). We use 10°C as the base and 30°C as the maximum for the GDD calculation.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.height = 7.73, fig.align = "left"}

# Subset the dataframe to only have the 2 sigma data and the unique lab code.
MDB_min_rayshader <- MDB %>%
  dplyr::select(LabID, SiteName, Date, Lat, everything()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(
    Lat >= MDB %>% dplyr::filter(SiteName == "Guila Naquitz") %>% dplyr::pull(Lat) %>% dplyr::first()
  ) %>% 
  dplyr::left_join(., MDB_gdd, by = "LabID")

# Using rayshader with GDD.
mtplot <- 
  MDB_min_rayshader %>%
  dplyr::mutate(Province = as.factor(Province)) %>%
  dplyr::arrange(Date) %>%
  ggplot(aes(x = Date, y = Lat, color = gdd)) +
  geom_point(size = 2) +
  scale_colour_gradientn(limits = c(0, 7000), colors = colorRampPalette(rev(RColorBrewer::brewer.pal(8, "RdBu")))(150)) +
  scale_x_continuous(
    breaks = c(seq(-4500,-500, 1000), 1, seq(500, 1500, 1000)),
    minor_breaks = c(seq(-4000,-1000, 1000), 1000),
    limits = c(-4500, 1500),
    guide = "axis_minor",
    labels = c(seq(-4500,-500, 1000), 1, seq(500, 1500, 1000))
  ) +
  scale_y_continuous(
    breaks = seq(10, 45, 5),
    minor_breaks = seq(10, 45, 1),
    limits = c(10, 45),
    guide = "axis_minor"
  ) +
  xlab("Years BC/AD") +
  ylab("Latitude") +
  labs(colour = "GDD") +
  theme_bw()  +
  theme(
    legend.title = element_text(
      size = 14,
      family = "Helvetica",
      face = "bold"
    ),
    legend.title.align = 1.0,
    legend.position = "right",
    legend.direction = "vertical",
    legend.text = element_text(size = 12, colour = "black"),
    legend.margin = margin(t = -14),
    axis.ticks.length = unit(0.125, "inch"),
    ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 12,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 7,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 14,
      family = "Helvetica",
      margin = margin(
        t = 7,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

rayshader::plot_gg(
  mtplot,
  width = 6.5,
  height = 4,
  multicore = TRUE,
  windowsize = c(1000, 1000),
  zoom = 0.77,
  phi = 50,
  theta = 35,
  sunangle = 225,
  soliddepth = -0.5,
  pointcontract = 0.7,
  scale = 200
)
rayshader::render_snapshot(clear = TRUE, filename = "vignettes/figures/rayshader_gdd.png")

```